<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Tracker</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèñÔ∏è</text></svg>">

    <style>
        :root {
            --bg-color: #f5f7fa;
            --primary: #25457B;
            --primary-hover: #1a325e;
            --accent: #00B8FF;
            --surface: #FFFFFF;
            --text-sec: #607690;
            --success: #13AA09;
            --error: #FE4A3F;
            --shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            --border: 1px solid #e0e0e0;
            --radius: 8px;
            --font: 'IBM Plex Sans', sans-serif;
        }

        * { box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg-color); margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }

        /* Components */
        .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; margin-bottom: 24px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: var(--radius); cursor: pointer; font-weight: 500; font-family: var(--font); display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; white-space: nowrap; }
        .btn:hover { background: var(--primary-hover); }
        .btn.secondary { background: white; border: var(--border); color: var(--text-sec); }
        .btn.secondary:hover { background: #f8f9fa; }
        .btn.danger { background: var(--error); }
        .btn.sm { padding: 6px 12px; font-size: 0.85rem; }
        
        input, select { width: 100%; padding: 10px 12px; margin: 6px 0 16px; border: var(--border); border-radius: var(--radius); font-family: var(--font); font-size: 0.95rem; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--primary); display: block; margin-top: 8px; }
        
        /* Layout & Responsive */
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; width: 100%; }
        .navbar { background: var(--surface); border-bottom: 1px solid #eee; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); position: sticky; top:0; z-index: 50; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 1.2rem; color: var(--primary); }
        
        /* Grid Systems */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } 
        /* Removed margin-bottom from stats-grid per request */
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row { display: flex; gap: 10px; align-items: flex-end; }
        
        /* Mobile Breakpoint */
        @media (max-width: 768px) {
            .navbar { padding: 0.8rem 1rem; flex-direction: column; gap: 10px; }
            .stats-grid, .grid-2 { grid-template-columns: 1fr; }
            .form-row { flex-direction: column; align-items: stretch; }
            .btn { width: 100%; }
            .mobile-hide { display: none; }
        }

        /* Specifics */
        .stat-card { text-align: center; padding: 24px; }
        .stat-card h3 { color: var(--text-sec); font-size: 0.9rem; margin: 0; }
        .stat-card .value { color: var(--primary); font-size: 2.2rem; font-weight: 600; margin: 8px 0; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .section-header h2 { font-size: 1.1rem; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; background: #f9f9f9; color: var(--primary); font-size: 0.8rem; padding: 12px; border-bottom: 1px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; color: #444; font-size: 0.9rem; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge.Approved { background: #e6f6e5; color: var(--success); }
        .badge.Rejected { background: #ffebeb; color: var(--error); }
        .badge.Pending { background: #e3f2fd; color: var(--primary); }

        /* Overlays */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: var(--radius); padding: 24px; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        
        .manage-section { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 20px; border: 1px solid #eee; }
        .manage-section h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 0.9rem; }

        .hidden { display: none !important; }
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; z-index: 3000; pointer-events: none; display: flex; gap: 8px; align-items: center; white-space: nowrap; }
    </style>
</head>
<body>

<div id="loader" class="loader"><div class="spinner"></div></div>
<div id="toast" class="toast"></div>

<nav class="navbar hidden" id="navbar">
    <div class="logo"><span class="material-symbols-outlined">beach_access</span> Vacation Tracker</div>
    <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
        <button class="btn secondary sm" onclick="openPassModal()"><span class="material-symbols-outlined">lock</span> Password</button>
        <span id="userDisplay" style="color:var(--text-sec); font-size:0.9rem; font-weight:500;"></span>
        <button class="btn secondary sm" onclick="logout()">Logout</button>
    </div>
</nav>

<div class="container">
    <div id="view-login" style="display:flex; justify-content:center; align-items:center; min-height:80vh;">
        <div class="card" style="width:100%; max-width:400px; text-align:center;">
            <div style="color:var(--primary); margin-bottom:15px;"><span class="material-symbols-outlined" style="font-size:48px;">beach_access</span></div>
            <h2 style="color:var(--primary); margin-top:0;">Welcome Back</h2>
            <input type="email" id="loginEmail" placeholder="Email Address">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="btn" style="width:100%;" onclick="login()">Sign In</button>
            <div id="loginError" style="color:var(--error); margin-top:15px; font-size:0.9rem;"></div>
        </div>
    </div>

    <div id="view-dashboard" class="hidden">
        
        <div id="adminPanel" class="card hidden">
            <div class="section-header">
                <h2><span class="material-symbols-outlined">supervisor_account</span> User Management</h2>
                <button id="btnAddUser" class="btn sm hidden" onclick="openCreateUserModal()">+ Add User</button>
            </div>
            <div class="table-wrap">
                <table id="userTable">
                    <thead><tr><th>Name</th><th>Email</th><th>Country</th><th>Role</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="stats-grid" style="margin-bottom: 24px;"> <div class="card stat-card"><h3>Annual Remaining</h3><div class="value" id="balAnnual">--</div></div>
            <div class="card stat-card"><h3>In-Lieu Remaining</h3><div class="value" id="balInLieu">--</div></div>
        </div>

        <div id="reviewSection" class="card hidden">
            <div class="section-header"><h2><span class="material-symbols-outlined">notifications_active</span> Pending Requests</h2></div>
            <div id="pendingList"></div>
        </div>

        <div class="card">
            <div class="section-header"><h2><span class="material-symbols-outlined">add_circle</span> New Request</h2></div>
            <form onsubmit="submitRequest(event)">
                <div class="grid-2">
                    <div><label>Start Date</label><input type="date" id="reqStart" required></div>
                    <div><label>End Date</label><input type="date" id="reqEnd" required></div>
                </div>
                <label>Type</label>
                <select id="reqType">
                    <option value="Annual">Annual Leave</option>
                    <option value="InLieu">In-Lieu</option>
                </select>
                <button type="submit" class="btn">Submit Request</button>
            </form>
        </div>

        <div class="card">
            <div class="section-header"><h2><span class="material-symbols-outlined">history</span> My History</h2></div>
            <div class="table-wrap">
                <table id="historyTable">
                    <thead><tr><th>Type</th><th>Dates</th><th>Days</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modalManage" class="overlay">
    <div class="modal">
        <div class="modal-header">
            <span><span class="material-symbols-outlined icon">supervisor_account</span> Manage User</span>
            <button class="close-btn" onclick="closeModal('modalManage')">&times;</button>
        </div>
        <form onsubmit="saveUserDetails(event)">
            <input type="hidden" id="mOrigEmail">
            <div class="grid-2">
                <div><label>Full Name</label><input type="text" id="mName" required></div>
                <div><label>Country</label><select id="mCountry"></select></div>
            </div>
            <label>Email</label><input type="email" id="mEmail" required>
            <label>Manager Email</label><input type="email" id="mManager">
            
            <div id="adminFields" class="hidden">
                <div class="grid-2">
                    <div><label>Role</label><select id="mRole"><option>Member</option><option>Lead</option><option>Manager</option><option>Admin</option></select></div>
                    <div><label>Reset Password</label><input type="text" id="mPass" placeholder="Optional"></div>
                </div>
            </div>
            <button type="submit" class="btn" style="width:100%">Save Details</button>
        </form>

        <div class="manage-section">
            <h4>Adjust Annual Leave</h4>
            <div class="form-row">
                <div style="flex:1"><input type="number" id="adjAnnAmt" placeholder="+/- Days"></div>
                <div style="flex:2"><input type="text" id="adjAnnDesc" placeholder="Reason (e.g. Bonus)"></div>
            </div>
            <button class="btn secondary sm" style="width:100%" onclick="adjustBalance('Annual')">Update Annual Balance</button>
        </div>

        <div class="manage-section">
            <h4>Add In-Lieu Day</h4>
            <div class="grid-2">
                <div><label>Date (Required)</label><input type="date" id="adjLieuDate"></div>
                <div><label>Days</label><input type="number" id="adjLieuAmt" value="1"></div>
            </div>
            <label>Description (Required)</label><input type="text" id="adjLieuDesc" placeholder="e.g. Weekend Support">
            <button class="btn secondary sm" style="width:100%" onclick="adjustBalance('InLieu')">Add In-Lieu</button>
        </div>
    </div>
</div>

<div id="modalPass" class="overlay">
    <div class="modal">
        <div class="modal-header"><span>Change Password</span><button class="close-btn" onclick="closeModal('modalPass')">&times;</button></div>
        <label>Current Password</label><input type="password" id="oldPass">
        <label>New Password</label><input type="password" id="newPass">
        <button class="btn" style="width:100%" onclick="updateOwnPassword()">Update Password</button>
    </div>
</div>

<div id="modalCreate" class="overlay">
    <div class="modal">
        <div class="modal-header"><span>Create User</span><button class="close-btn" onclick="closeModal('modalCreate')">&times;</button></div>
        <form onsubmit="createUser(event)">
            <label>Email</label><input type="email" id="cEmail" required>
            <div class="grid-2">
                <div><label>Password</label><input type="text" id="cPass" required></div>
                <div><label>Name</label><input type="text" id="cName" required></div>
            </div>
            <div class="grid-2">
                <div><label>Role</label><select id="cRole"><option>Member</option><option>Lead</option><option>Manager</option></select></div>
                <div><label>Country</label><select id="cCountry"></select></div>
            </div>
            <label>Manager Email</label><input type="email" id="cManager">
            <button type="submit" class="btn" style="width:100%">Create User</button>
        </form>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyW2TYLJ3gRoMsBWpzaRUwYaGDfFHx6YbDGRvxnt3KrLtOLhwmBN_rIiIYMZH0xwkR7/exec';
    const COUNTRIES = [
        {code:'ID', flag:'üáÆüá©'}, {code:'PH', flag:'üáµüá≠'}, {code:'SG', flag:'üá∏üá¨'}, 
        {code:'VN', flag:'üáªüá≥'}, {code:'MY', flag:'üá≤üáæ'}, {code:'TH', flag:'üáπüá≠'},
        {code:'IN', flag:'üáÆüá≥'}, {code:'US', flag:'üá∫üá∏'}, {code:'AU', flag:'üá¶üá∫'}
    ];
    let currentUser = null;

    // --- Utils ---
    const $ = id => document.getElementById(id);
    const showLoader = s => $('loader').style.display = s ? 'flex' : 'none';
    const closeModal = id => $(id).classList.remove('active');
    const showToast = (msg, type='info') => {
        const t = $('toast'); t.innerHTML = `<span class="material-symbols-outlined">${type==='error'?'error':'check_circle'}</span> ${msg}`;
        t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 3000);
    };

    function populateCountries(selectId) {
        const sel = $(selectId); sel.innerHTML = '';
        COUNTRIES.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.code; opt.innerHTML = `${c.flag} ${c.code}`;
            sel.appendChild(opt);
        });
    }

    async function api(data) {
        showLoader(true);
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            const json = await res.json();
            showLoader(false);
            return json;
        } catch(e) { showLoader(false); showToast("Network Error", "error"); return {status:'error'}; }
    }

    // --- Auth ---
    async function login() {
        const res = await api({ action: 'login', email: $('loginEmail').value, password: $('loginPass').value });
        if(res.status === 'success') {
            currentUser = res.user;
            $('userDisplay').innerText = currentUser.name;
            $('view-login').classList.add('hidden');
            $('view-dashboard').classList.remove('hidden');
            $('navbar').classList.remove('hidden');
            initDashboard();
        } else $('loginError').innerText = res.message;
    }
    function logout() { location.reload(); }

    function openPassModal() { $('modalPass').classList.add('active'); }
    async function updateOwnPassword() {
        const o = $('oldPass').value, n = $('newPass').value;
        if(!o || !n) return showToast("Both fields required", "error");
        const res = await api({ action: 'changeOwnPassword', email: currentUser.email, oldPassword: o, newPassword: n });
        if(res.status === 'success') { showToast("Password Changed"); closeModal('modalPass'); }
        else showToast(res.message, "error");
    }

    // --- Dashboard ---
    async function initDashboard() {
        const res = await api({ action: 'getDashboard', email: currentUser.email, role: currentUser.role });
        $('balAnnual').innerText = res.balance.annual - res.balance.annualUsed;
        $('balInLieu').innerText = res.balance.inLieu - res.balance.inLieuUsed;
        $('historyTable').querySelector('tbody').innerHTML = res.myRequests.map(r => `<tr><td>${r.type}</td><td>${r.start} to ${r.end}</td><td>${r.days}</td><td><span class="badge ${r.status}">${r.status}</span></td></tr>`).join('');
        
        if(['Manager','Lead','Admin'].includes(currentUser.role)) {
            $('reviewSection').classList.remove('hidden');
            $('pendingList').innerHTML = res.teamRequests.map(r => `<div style="padding:15px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><div><strong>${r.email}</strong><br><small>${r.type} ‚Ä¢ ${r.days} Days ‚Ä¢ ${r.start}</small></div><div><button class="btn success sm" onclick="decide('${r.id}','Approved')">Approve</button> <button class="btn danger sm" onclick="decide('${r.id}','Rejected')">Reject</button></div></div>`).join('') || '<p style="color:#999">No pending requests.</p>';
            
            $('adminPanel').classList.remove('hidden');
            if(currentUser.role === 'Admin') $('btnAddUser').classList.remove('hidden');
            loadUserList();
        }
    }
    async function submitRequest(e) { e.preventDefault(); await api({ action: 'submitRequest', email: currentUser.email, start:$('reqStart').value, end:$('reqEnd').value, type:$('reqType').value }); showToast("Submitted"); initDashboard(); }
    async function decide(id, d) { await api({ action: 'approveReject', id, decision: d }); initDashboard(); }

    // --- Admin/Manager ---
    async function loadUserList() {
        const res = await api({ action: 'getUsersList', requestorEmail: currentUser.email, requestorRole: currentUser.role });
        $('userTable').querySelector('tbody').innerHTML = res.users.map(u => `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.country}</td><td>${u.role}</td><td><button class="btn secondary sm" onclick="openManageModal('${u.email}')">Manage</button></td></tr>`).join('');
    }

    async function openManageModal(email) {
        populateCountries('mCountry');
        const res = await api({ action: 'getUserDetails', targetEmail: email });
        const u = res.user;
        $('mOrigEmail').value = u.email; $('mEmail').value = u.email; $('mName').value = u.name; $('mManager').value = u.manager; $('mCountry').value = u.country;
        
        if(currentUser.role === 'Admin') {
            $('adminFields').classList.remove('hidden');
            $('mRole').value = u.role;
            $('mPass').value = '';
        } else $('adminFields').classList.add('hidden');
        
        $('modalManage').classList.add('active');
    }

    async function saveUserDetails(e) {
        e.preventDefault();
        await api({
            action: 'updateUserDetails', requestorRole: currentUser.role,
            originalEmail: $('mOrigEmail').value, email: $('mEmail').value,
            name: $('mName').value, manager: $('mManager').value, country: $('mCountry').value,
            role: $('mRole').value, password: $('mPass').value
        });
        showToast("Saved"); closeModal('modalManage'); loadUserList();
    }

    async function adjustBalance(type) {
        const amt = type === 'Annual' ? $('adjAnnAmt').value : $('adjLieuAmt').value;
        const desc = type === 'Annual' ? $('adjAnnDesc').value : $('adjLieuDesc').value;
        const date = type === 'InLieu' ? $('adjLieuDate').value : '';

        if(!amt || !desc) return showToast("Amount and Description required", "error");
        if(type === 'InLieu' && !date) return showToast("Date is required for In-Lieu", "error");

        await api({
            action: 'adjustBalance', requestorEmail: currentUser.email,
            targetEmail: $('mOrigEmail').value, type, amount: amt, description: desc, date
        });
        showToast("Balance Updated"); closeModal('modalManage');
    }

    function openCreateUserModal() { populateCountries('cCountry'); $('modalCreate').classList.add('active'); }
    async function createUser(e) {
        e.preventDefault();
        await api({ action: 'createUser', email:$('cEmail').value, password:$('cPass').value, name:$('cName').value, role:$('cRole').value, manager:$('cManager').value, country:$('cCountry').value });
        showToast("User Created"); closeModal('modalCreate'); loadUserList();
    }
</script>
</body>
</html>
