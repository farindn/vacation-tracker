<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vacation Tracker</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèñÔ∏è</text></svg>">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0');

        :root {
          --color-primary: #1E293B;
          --color-primary-hover: #0F172A;
          --color-accent: #F59E0B;
          --color-slate: #94A3B8;
          --color-white: #FFFFFF;
          --color-error: #DC2626;
          --color-success: #16A34A;
          --box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
          --radius-md: 12px;
          --radius-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'IBM Plex Sans', sans-serif; font-size: 16px; background: #f5f7fa; color: var(--color-primary); -webkit-font-smoothing: antialiased; }
        input, button, textarea, select { font-family: inherit; }
        .hidden { display: none !important; }

        /* Login */
        .login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1.5rem; }
        .login-box { width: 100%; max-width: 380px; padding: 2.5rem 2rem; background: var(--color-white); border-radius: var(--radius-lg); box-shadow: var(--box-shadow); text-align: center; }
        .app-title { font-size: 1.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--color-primary); }
        .subtitle { font-size: 0.95rem; color: var(--color-slate); margin-bottom: 2rem; }

        /* Forms */
        .input-group { margin-bottom: 1.25rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; color: var(--color-primary); }
        .input-field { display: flex; align-items: center; background: var(--color-white); border: 1px solid #cbd3dc; border-radius: var(--radius-md); padding: 0.75rem 1rem; }
        .input-field:focus-within { border-color: var(--color-accent); }
        .input-field input, .input-field select { flex: 1; border: none; background: transparent; font-size: 1rem; outline: none; color: var(--color-primary); width: 100%; }
        .input-field .material-symbols-rounded { font-size: 1.25rem; margin-right: 0.75rem; color: var(--color-slate); }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-danger { padding: 0.8rem 1.2rem; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 500; cursor: pointer; width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: transparent; border: 1px solid #cbd3dc; color: var(--color-slate); }
        .btn-secondary:hover { background-color: #f1f4f7; color: var(--color-primary); }
        .btn-danger { background-color: var(--color-error); color: white; width: auto; padding: 0.5rem 1rem; font-size: 0.85rem;}
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; width: auto; }

        /* Dashboard */
        .dashboard { padding: 2rem; max-width: 1100px; margin: auto; }
        .section-title { font-size: 1.15rem; font-weight: 600; padding-bottom: 0.75rem; margin-bottom: 1.25rem; border-bottom: 1px solid #e1e5eb; color: var(--color-primary); display: flex; justify-content: space-between; align-items: center; }
        .section-title .header-left { display: flex; align-items: center; gap: 8px; }
        .section-title .material-symbols-rounded { color: var(--color-accent); font-size: 1.4rem; }

        /* Cards */
        .dashboard-cards { display: flex; gap: 1.5rem; margin-bottom: 2.5rem; }
        .card { flex: 1; background: var(--color-white); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--box-shadow); display: flex; flex-direction: row; align-items: center; justify-content: space-between; }
        .card-icon { font-size: 2.5rem; color: var(--color-accent); display: flex; align-items: center; justify-content: center; background: #f0f7ff; padding: 0.75rem; border-radius: 50%; }
        .card-content { display: flex; flex-direction: column; align-items: flex-end; text-align: right; }
        .card-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--color-slate); margin-bottom: 0.25rem; font-weight: 600; }
        .card-value { font-family: 'IBM Plex Mono', monospace; font-size: 2rem; font-weight: 600; color: var(--color-primary); line-height: 1; }

        /* List/Table Cards (Global Style for consistency) */
        .list-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--box-shadow);
            border: 1px solid #e1e5eb;
            width: 100%;
        }

        /* Tables & Wrappers */
        .table-wrapper { background: var(--color-white); border-radius: var(--radius-lg); box-shadow: var(--box-shadow); overflow: hidden; margin-bottom: 2.5rem; border: 1px solid #f0f0f0; width: 100%; }
        .form-container { padding: 2rem; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: var(--color-slate); padding: 1rem 1.5rem; font-size: 0.8rem; text-transform: uppercase; font-weight: 600; text-align: left; border-bottom: 1px solid #e1e5eb; }
        td { padding: 1rem 1.5rem; font-size: 0.95rem; border-bottom: 1px solid #f0f0f0; color: var(--color-primary); }
        tr:last-child td { border-bottom: none; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.Approved { background: #e6f6e5; color: var(--color-success); }
        .badge.Rejected { background: #ffebeb; color: var(--color-error); }
        .badge.Pending { background: #e3f2fd; color: var(--color-primary); }

        /* Navbar */
        .navbar { background-color: var(--color-primary); padding: 0.85rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .navbar-brand { font-size: 1.1rem; font-weight: 600; color: var(--color-white); display: flex; align-items: center; gap: 8px; }
        .navbar-brand .material-symbols-rounded { font-size: 1.5rem; }
        .user-menu { display: flex; align-items: center; gap: 1rem; }
        .user-details { text-align: right; line-height: 1.2; color: white; }
        .user-name { font-size: 0.9rem; font-weight: 600; display: block; }
        .user-role { font-size: 0.75rem; opacity: 0.8; display: block; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Modals */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); padding: 1rem; }
        .overlay.active { display: flex; }
        .modal { background: var(--color-white); width: 100%; max-width: 480px; padding: 2rem; border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.2rem; color: var(--color-primary); margin: 0; display: flex; align-items: center; gap: 8px; }
        .close-icon { background: none; border: none; color: var(--color-slate); cursor: pointer; font-size: 1.5rem; padding: 0; display: flex; }
        
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translate(-50%, 20px); background: #333; color: white; padding: 0.75rem 1.5rem; border-radius: 50px; font-size: 0.9rem; z-index: 3000; opacity: 0; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; pointer-events: none; }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }
        .toast.success { background-color: var(--color-success); }
        .toast.error { background-color: var(--color-error); }
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .loader { width: 40px; height: 40px; border: 4px solid #e1e5eb; border-top: 4px solid var(--color-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .manage-box { background: #f8f9fa; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; border: 1px solid #e1e5eb; }
        .manage-box h4 { font-size: 0.85rem; color: var(--color-primary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Common row content styles */
        .m-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f0f0f0; }
        .m-title { font-weight: 600; color: var(--color-primary); font-size: 0.95rem; }
        .m-sub { font-size: 0.85rem; color: var(--color-slate); display: flex; align-items: center; gap: 4px; }

        /* --- MOBILE STYLES --- */
        .mobile-row { display: none; } /* Hidden on desktop */
        
        @media (max-width: 768px) {
            .dashboard { padding: 1.5rem 1rem; }
            .navbar { padding: 0.75rem 1rem; }
            .user-details { display: none; }
            .section-title { font-size: 1.05rem; margin-bottom: 1rem; }
            .btn-primary, .btn-secondary { padding: 0.75rem; font-size: 0.9rem; }
            
            /* Card Layout: Column on Mobile */
            .dashboard-cards { flex-direction: row; flex-wrap: wrap; gap: 1rem; }
            .card { flex-basis: 100%; flex-direction: column; align-items: center; text-align: center; padding: 1.5rem 1rem; }
            .card-icon { margin-bottom: 1rem; font-size: 2rem; padding: 0.6rem; }
            .card-content { align-items: center; text-align: center; }
            .card-title { font-size: 0.8rem; }
            .card-value { font-size: 1.8rem; }

            /* Table Layout for Mobile */
            .table-wrapper.has-table { background: transparent; box-shadow: none; border: none; }
            table { min-width: 100%; display: block; }
            thead { display: none; } /* Hide Headers */
            tbody { display: block; width: 100%; }
            
            .desktop-row { display: none; } /* Hide Desktop Rows */
            .mobile-row { display: block; width: 100%; margin-bottom: 1rem; }
            .mobile-row td { display: block; padding: 0; border: none; background: transparent; }
            
            .form-container { padding: 1.25rem; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay"><div class="loader"></div></div>
    <div id="toast" class="toast"></div>

    <nav class="navbar hidden" id="navbar">
        <div class="navbar-brand"><span class="material-symbols-rounded">beach_access</span> Vacation Tracker</div>
        <div class="user-menu">
            <div class="user-details"><span class="user-name" id="userDisplay">User</span><span class="user-role" id="userRoleDisplay">Member</span></div>
            <button class="nav-btn" onclick="openPassModal()"><span class="material-symbols-rounded">lock</span></button>
            <button class="nav-btn" onclick="logout()"><span class="material-symbols-rounded">logout</span></button>
        </div>
    </nav>

    <div id="view-login" class="login-page">
        <div class="login-box">
            <h2 class="app-title"><span class="material-symbols-rounded" style="font-size:2rem;">beach_access</span></h2>
            <h2 class="app-title">Vacation Tracker</h2>
            <p class="subtitle">Manage your vacation</p>
            <div class="input-group"><label>Email</label><div class="input-field"><span class="material-symbols-rounded">mail</span><input type="email" id="loginEmail" placeholder="name@company.com"></div></div>
            <div class="input-group"><label>Password</label><div class="input-field"><span class="material-symbols-rounded">key</span><input type="password" id="loginPass" placeholder="Password"></div></div>
            <button class="btn-primary" onclick="login()">Sign In</button>
            <div id="loginError" style="color:var(--color-error); margin-top:1rem; font-size:0.9rem;"></div>
        </div>
    </div>

    <div id="view-dashboard" class="dashboard hidden">
        
        <div id="adminPanel" class="hidden" style="margin-bottom: 2rem;">
            <div class="section-title">
                <div class="header-left"><span class="material-symbols-rounded">supervisor_account</span> User Management</div>
                <button id="btnAddUser" class="btn-primary btn-sm hidden" onclick="openCreateUserModal()">+ Add User</button>
            </div>
            <div class="table-wrapper has-table">
                <table id="userTable">
                    <thead><tr><th>Name</th><th>Email</th><th>Country</th><th>Role</th><th style="text-align:right">Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section-title"><div class="header-left"><span class="material-symbols-rounded">account_balance_wallet</span> My Balance</div></div>
        <div class="dashboard-cards">
            <div class="card">
                <div class="card-icon"><span class="material-symbols-rounded">calendar_month</span></div>
                <div class="card-content"><div class="card-title">Annual Remaining</div><div class="card-value" id="balAnnual">--</div></div>
            </div>
            <div class="card">
                <div class="card-icon"><span class="material-symbols-rounded">event_available</span></div>
                <div class="card-content"><div class="card-title">In-Lieu Remaining</div><div class="card-value" id="balInLieu">--</div></div>
            </div>
        </div>

        <div id="reviewSection" class="hidden" style="margin-bottom: 2rem;">
            <div class="section-title"><div class="header-left"><span class="material-symbols-rounded">notifications_active</span> Pending Requests</div></div>
            <div id="pendingList"></div>
        </div>

        <div class="section-title"><div class="header-left"><span class="material-symbols-rounded">add_circle</span> New Request</div></div>
        <div class="table-wrapper">
            <div class="form-container">
                <form onsubmit="submitRequest(event)">
                    <div class="grid-2">
                        <div class="input-group"><label>Start Date</label><div class="input-field"><input type="date" id="reqStart" required></div></div>
                        <div class="input-group"><label>End Date</label><div class="input-field"><input type="date" id="reqEnd" required></div></div>
                    </div>
                    <div class="input-group"><label>Leave Type</label><div class="input-field"><select id="reqType"><option value="Annual">Annual Leave</option><option value="InLieu">In-Lieu</option></select></div></div>
                    <button type="submit" class="btn-primary" style="width: auto; min-width: 150px;">Submit Request</button>
                </form>
            </div>
        </div>

        <div class="section-title"><div class="header-left"><span class="material-symbols-rounded">history</span> My History</div></div>
        <div class="table-wrapper has-table">
            <table id="historyTable">
                <thead><tr><th>Type</th><th>Dates</th><th>Days</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="modalManage" class="overlay">
        <div class="modal">
            <div class="modal-header"><h3><span class="material-symbols-rounded">manage_accounts</span> Manage User</h3><button class="close-icon" onclick="closeModal('modalManage')"><span class="material-symbols-rounded">close</span></button></div>
            <form onsubmit="saveUserDetails(event)">
                <input type="hidden" id="mOrigEmail">
                <div class="input-group"><label>Full Name</label><div class="input-field"><input type="text" id="mName" required></div></div>
                <div class="grid-2">
                    <div class="input-group"><label>Email</label><div class="input-field"><input type="email" id="mEmail" required></div></div>
                    <div class="input-group"><label>Country</label><div class="input-field"><select id="mCountry"></select></div></div>
                </div>
                <div class="input-group"><label>Manager Email</label><div class="input-field"><input type="email" id="mManager"></div></div>
                <div id="adminFields" class="hidden">
                    <div class="grid-2">
                        <div class="input-group"><label>Role</label><div class="input-field"><select id="mRole"><option>Member</option><option>Lead</option><option>Manager</option><option>Admin</option></select></div></div>
                        <div class="input-group"><label>Reset Password</label><div class="input-field"><input type="text" id="mPass" placeholder="Optional"></div></div>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
            
            <div class="manage-box">
                <h4>Adjust Annual Leave</h4>
                <div class="grid-2">
                    <div class="input-field"><input type="number" id="adjAnnAmt" placeholder="+/- Days"></div>
                    <div class="input-field"><input type="text" id="adjAnnDesc" placeholder="Reason"></div>
                </div>
                <button class="btn-primary btn-sm" style="width:100%; margin-top:10px" onclick="adjustBalance('Annual')">Update</button>
            </div>
            
            <div class="manage-box">
                <h4>Add In-Lieu Day</h4>
                <div class="grid-2">
                    <div class="input-field"><input type="date" id="adjLieuDate"></div>
                    <div style="display:flex; align-items:center; background:white; border:1px solid #cbd3dc; border-radius:12px; padding:0 1rem; color:var(--color-primary); font-weight:600;">
                        1 Day <input type="hidden" id="adjLieuAmt" value="1">
                    </div>
                </div>
                <div class="input-field" style="margin-top:10px"><input type="text" id="adjLieuDesc" placeholder="Description (Required)"></div>
                <button class="btn-primary btn-sm" style="width:100%; margin-top:10px" onclick="adjustBalance('InLieu')">Add In-Lieu</button>
            </div>
        </div>
    </div>

    <div id="modalPass" class="overlay">
        <div class="modal">
            <div class="modal-header"><h3><span class="material-symbols-rounded">lock_reset</span> Change Password</h3><button class="close-icon" onclick="closeModal('modalPass')"><span class="material-symbols-rounded">close</span></button></div>
            <div class="input-group"><label>Current Password</label><div class="input-field"><input type="password" id="oldPass"></div></div>
            <div class="input-group"><label>New Password</label><div class="input-field"><input type="password" id="newPass"></div></div>
            <button class="btn-primary" onclick="updateOwnPassword()">Update</button>
        </div>
    </div>

    <div id="modalCreate" class="overlay">
        <div class="modal">
            <div class="modal-header"><h3><span class="material-symbols-rounded">person_add</span> Create User</h3><button class="close-icon" onclick="closeModal('modalCreate')"><span class="material-symbols-rounded">close</span></button></div>
            <form onsubmit="createUser(event)">
                <div class="input-group"><label>Email</label><div class="input-field"><input type="email" id="cEmail" required></div></div>
                <div class="grid-2">
                    <div class="input-group"><label>Password</label><div class="input-field"><input type="text" id="cPass" required></div></div>
                    <div class="input-group"><label>Name</label><div class="input-field"><input type="text" id="cName" required></div></div>
                </div>
                <div class="grid-2">
                    <div class="input-group"><label>Role</label><div class="input-field"><select id="cRole"><option>Member</option><option>Lead</option><option>Manager</option></select></div></div>
                    <div class="input-group"><label>Country</label><div class="input-field"><select id="cCountry"></select></div></div>
                </div>
                <div class="input-group"><label>Manager Email</label><div class="input-field"><input type="email" id="cManager"></div></div>
                <button type="submit" class="btn-primary">Create User</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzxf06v32KD_1WYaKsGSCBJR1nue58GSHBe9NnwOzU1X87EAh_lHMsuJPpJ96pjegYi/exec';
        
        const COUNTRIES = [{code:'ID',flag:'üáÆüá©'},{code:'PH',flag:'üáµüá≠'},{code:'SG',flag:'üá∏üá¨'},{code:'VN',flag:'üáªüá≥'},{code:'MY',flag:'üá≤üáæ'},{code:'TH',flag:'üáπüá≠'},{code:'IN',flag:'üáÆüá≥'},{code:'US',flag:'üá∫üá∏'},{code:'AU',flag:'üá¶üá∫'}];
        let currentUser = null;
        const $ = id => document.getElementById(id);
        const showLoader = s => $('loader').style.display = s ? 'flex' : 'none';
        const closeModal = id => $(id).classList.remove('active');
        const showToast = (msg, type='info') => {
            const t = $('toast'); t.className = `toast show ${type}`;
            t.innerHTML = `<span class="material-symbols-rounded">${type==='error'?'error':'check_circle'}</span> ${msg}`;
            setTimeout(() => t.className = 'toast', 3000);
        };
        const populateCountries = (sid) => { const s=$(sid); s.innerHTML=''; COUNTRIES.forEach(c=>{const o=document.createElement('option');o.value=c.code;o.innerText=`${c.flag} ${c.code}`;s.appendChild(o)});};
        
        // Session Check
        window.onload = () => {
            const stored = localStorage.getItem('vt_user');
            if(stored) {
                try { currentUser = JSON.parse(stored); updateUI(); } catch(e){ localStorage.removeItem('vt_user'); }
            }
        };

        function updateUI() {
            $('userDisplay').innerText = currentUser.name;
            $('userRoleDisplay').innerText = currentUser.role;
            $('view-login').classList.add('hidden'); $('view-dashboard').classList.remove('hidden'); $('navbar').classList.remove('hidden');
            initDashboard();
        }

        async function api(data) {
            showLoader(true);
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
                const json = await res.json();
                showLoader(false); return json;
            } catch(e) { showLoader(false); showToast("Network Error", "error"); return {status:'error'}; }
        }

        async function login() {
            const res = await api({ action: 'login', email: $('loginEmail').value, password: $('loginPass').value });
            if(res.status === 'success') {
                currentUser = res.user;
                localStorage.setItem('vt_user', JSON.stringify(currentUser));
                updateUI();
            } else $('loginError').innerText = res.message;
        }
        function logout() { localStorage.removeItem('vt_user'); location.reload(); }
        function openPassModal() { $('modalPass').classList.add('active'); }
        async function updateOwnPassword() {
            const o = $('oldPass').value, n = $('newPass').value;
            if(!o||!n) return showToast("Required", "error");
            const res = await api({ action: 'changeOwnPassword', email: currentUser.email, oldPassword: o, newPassword: n });
            res.status==='success' ? (showToast("Updated", "success"), closeModal('modalPass')) : showToast(res.message, "error");
        }

        async function initDashboard() {
            const res = await api({ action: 'getDashboard', email: currentUser.email, role: currentUser.role });
            $('balAnnual').innerText = res.balance.annual - res.balance.annualUsed;
            $('balInLieu').innerText = res.balance.inLieu - res.balance.inLieuUsed;
            
            // History with Global .list-card style for mobile items
            $('historyTable').querySelector('tbody').innerHTML = res.myRequests.map(r => `
                <tr class="desktop-row">
                    <td>${r.type}</td><td>${r.start} - ${r.end}</td><td>${r.days}</td><td><span class="badge ${r.status}">${r.status}</span></td>
                </tr>
                <tr class="mobile-row">
                    <td>
                        <div class="list-card">
                            <div class="m-head">
                                <span class="m-title">${r.type}</span>
                                <span class="badge ${r.status}">${r.status}</span>
                            </div>
                            <div class="m-sub"><span class="material-symbols-rounded" style="font-size:1rem">calendar_today</span> ${r.start} - ${r.end} (${r.days} Days)</div>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Pending (Using Global .list-card)
            if(['Manager','Lead','Admin'].includes(currentUser.role)) {
                $('reviewSection').classList.remove('hidden');
                $('pendingList').innerHTML = res.teamRequests.map(r => `
                    <div class="list-card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div>
                            <div class="m-title">${r.email}</div>
                            <div class="m-sub">${r.type} ‚Ä¢ ${r.days} Days ‚Ä¢ ${r.start}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-primary btn-sm" style="background:var(--color-success)" onclick="decide('${r.id}','Approved')">Approve</button>
                            <button class="btn-danger btn-sm" onclick="decide('${r.id}','Rejected')">Reject</button>
                        </div>
                    </div>
                `).join('') || '<div style="padding:1rem; color:var(--color-slate); text-align:center; background:white; border-radius:12px; border:1px solid #e1e5eb;">No pending requests</div>';
                
                $('adminPanel').classList.remove('hidden');
                if(currentUser.role === 'Admin') $('btnAddUser').classList.remove('hidden');
                loadUserList();
            }
        }

        async function submitRequest(e) { e.preventDefault(); await api({ action: 'submitRequest', email: currentUser.email, start:$('reqStart').value, end:$('reqEnd').value, type:$('reqType').value }); showToast("Submitted", "success"); initDashboard(); }
        async function decide(id, d) { await api({ action: 'approveReject', id, decision: d }); initDashboard(); }

        async function loadUserList() {
            const res = await api({ action: 'getUsersList', requestorEmail: currentUser.email, requestorRole: currentUser.role });
            $('userTable').querySelector('tbody').innerHTML = res.users.map(u => `
                <tr class="desktop-row">
                    <td>${u.name}</td><td>${u.email}</td><td>${u.country}</td><td>${u.role}</td>
                    <td style="text-align:right"><button class="btn-secondary btn-sm" onclick="openManageModal('${u.email}')">Manage</button></td>
                </tr>
                <tr class="mobile-row">
                    <td>
                        <div class="list-card">
                            <div class="m-head"><span class="m-title">${u.name}</span><span style="font-size:0.8rem; opacity:0.7">${u.role}</span></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="m-sub">${u.email}</span>
                                <button class="btn-secondary btn-sm" onclick="openManageModal('${u.email}')">Manage</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function openManageModal(email) {
            populateCountries('mCountry');
            const res = await api({ action: 'getUserDetails', targetEmail: email });
            const u = res.user;
            $('mOrigEmail').value=u.email; $('mEmail').value=u.email; $('mName').value=u.name; $('mManager').value=u.manager; $('mCountry').value=u.country;
            if(currentUser.role==='Admin') { $('adminFields').classList.remove('hidden'); $('mRole').value=u.role; $('mPass').value=''; } else $('adminFields').classList.add('hidden');
            $('modalManage').classList.add('active');
        }

        async function saveUserDetails(e) {
            e.preventDefault();
            await api({ action: 'updateUserDetails', requestorRole: currentUser.role, originalEmail: $('mOrigEmail').value, email: $('mEmail').value, name: $('mName').value, manager: $('mManager').value, country: $('mCountry').value, role: $('mRole').value, password: $('mPass').value });
            showToast("Saved", "success"); closeModal('modalManage'); loadUserList();
        }

        async function adjustBalance(type) {
            const amt = type==='Annual'?$('adjAnnAmt').value:$('adjLieuAmt').value;
            const desc = type==='Annual'?$('adjAnnDesc').value:$('adjLieuDesc').value;
            const date = type==='InLieu'?$('adjLieuDate').value:'';
            if(!amt||!desc) return showToast("Details Missing", "error");
            await api({ action: 'adjustBalance', requestorEmail: currentUser.email, targetEmail: $('mOrigEmail').value, type, amount: amt, description: desc, date });
            showToast("Updated", "success"); closeModal('modalManage');
        }

        function openCreateUserModal() { populateCountries('cCountry'); $('modalCreate').classList.add('active'); }
        async function createUser(e) {
            e.preventDefault();
            await api({ action: 'createUser', email:$('cEmail').value, password:$('cPass').value, name:$('cName').value, role:$('cRole').value, manager:$('cManager').value, country:$('cCountry').value });
            showToast("Created", "success"); closeModal('modalCreate'); loadUserList();
        }
    </script>
</body>
</html>
